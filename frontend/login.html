<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0f2c">
    <title>Hyrje — Albanian Law AI</title>
    <link rel="icon" href="/static/img/logo.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="login-page-wrapper">
        <nav class="login-nav">
            <a href="/" class="login-nav-logo">
                <img src="/static/img/logo.png" alt="Logo">
                Albanian Law AI
            </a>
            <div class="login-nav-links">
                <a href="/pricing">Çmimet</a>
                <a href="/">Faqja kryesore</a>
            </div>
        </nav>

        <div class="login-center">
            <div class="login-card-modern">
                <div class="auth-tabs">
                    <button type="button" class="auth-tab active" data-tab="login">Hyr</button>
                    <button type="button" class="auth-tab" data-tab="register">Krijo llogari</button>
                </div>

                <div id="loginForm" class="auth-form">
                    <h2>Mirë se u ktheve</h2>
                    <p class="auth-subtitle">Hyr për të vazhduar me Albanian Law AI</p>
                    <form onsubmit="return handleLogin(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="ju@shembull.com">
                        </div>
                        <div class="form-group">
                            <label>Fjalëkalimi</label>
                            <input type="password" id="loginPassword" required placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;">
                        </div>
                        <button type="submit" class="btn-login-primary">Hyr</button>
                    </form>
                    <a href="#" id="forgotPasswordLink" class="forgot-link">Keni harruar fjalëkalimin?</a>
                    <div id="forgotPasswordForm" style="display:none;margin-top:16px;">
                        <form onsubmit="return handleForgotPassword(event)">
                            <div class="form-group">
                                <label>Email për rivendosje</label>
                                <input type="email" id="forgotEmail" required placeholder="ju@shembull.com">
                            </div>
                            <button type="submit" class="btn-login-primary">Dërgo linkun e rivendosjes</button>
                        </form>
                    </div>
                </div>

                <div id="registerForm" class="auth-form" style="display:none;">
                    <h2>Krijo llogari</h2>
                    <p class="auth-subtitle">Regjistrohu për provë falas 1-ditore. Pastaj 4.99&#8364;/muaj.</p>
                    <form onsubmit="return handleRegister(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="ju@shembull.com">
                        </div>
                        <div class="form-group">
                            <label>Fjalëkalimi (të paktën 8 karaktere)</label>
                            <input type="password" id="registerPassword" required minlength="8" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;">
                        </div>
                        <button type="submit" class="btn-login-primary">Krijo llogari</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="login-toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        document.querySelectorAll('.auth-tab').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tab = btn.dataset.tab;
                document.querySelectorAll('.auth-tab').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
                document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            });
        });

        (async function() { await initSupabaseAuth(); })();

        async function handleLogin(e) {
            e.preventDefault();
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            try {
                if (isSupabaseConfigured()) {
                    await supabaseSignIn(email, password);
                } else {
                    var res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, password: password }),
                    });
                    var data = await res.json();
                    if (!res.ok) throw new Error(data.detail || 'Hyrja dështoi');
                    setToken(data.token);
                }
                var redirect = new URLSearchParams(window.location.search).get('redirect') || '/app';
                window.location.href = redirect;
            } catch (err) {
                showToast(err.message, 'error');
            }
            return false;
        }

        async function handleRegister(e) {
            e.preventDefault();
            var email = document.getElementById('registerEmail').value.trim();
            var password = document.getElementById('registerPassword').value;
            try {
                await supabaseSignUp(email, password);
                var redirect = new URLSearchParams(window.location.search).get('redirect') || '/app';
                window.location.href = redirect;
            } catch (err) {
                showToast(err.message, 'error');
            }
            return false;
        }

        document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
            e.preventDefault();
            var form = document.getElementById('forgotPasswordForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });

        async function handleForgotPassword(e) {
            e.preventDefault();
            var email = document.getElementById('forgotEmail').value.trim();
            try {
                var res = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email }),
                });
                var data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Gabim');
                showToast('Kontrollo emailin per linkun e rivendosjes.', 'success');
                document.getElementById('forgotPasswordForm').style.display = 'none';
            } catch (err) {
                showToast(err.message, 'error');
            }
            return false;
        }

        function showToast(message, type) {
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'login-toast toast-' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() { toast.remove(); }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
