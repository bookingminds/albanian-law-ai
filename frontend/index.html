<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a365d">
    <title>Albanian Law AI — Asistent juridik</title>
    <meta name="description" content="Asistent juridik me AI për ligjin shqiptare. Bëj pyetje, merr përgjigje me burime.">
    <link rel="icon" href="/static/img/logo.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Mobile menu button -->
        <button type="button" class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Menu">&#9776;</button>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <a href="/app" class="sidebar-logo">
                <span class="icon">&#9878;</span>
                <span data-i18n="app.name">Albanian Law AI</span>
            </a>
            <button type="button" class="sidebar-new-chat" id="sidebarNewChat" onclick="newSession()">
                <span>+</span>
                <span data-i18n="chat.new_chat">Bisedë e re</span>
            </button>
            <div class="sidebar-scroll">
                <div id="sidebarSuggestedQuestions" class="sidebar-sq"></div>
                <div class="sidebar-chats" id="sidebarChats"></div>
            </div>
            <div class="sidebar-footer" id="sidebarFooter">
                <!-- Guest: Hyr / Regjistrohu. User: email, Aktivizo, Dil -->
                <a href="/login" class="btn btn-primary btn-outline-light" id="sidebarLogin" style="display:none;" data-i18n="auth.sign_in">Hyr</a>
                <a href="/login" class="btn btn-primary" id="sidebarSignup" style="display:none;">Regjistrohu</a>
                <div id="sidebarUser" style="display:none;">
                    <span class="user-email" id="sidebarUserEmail"></span>
                    <button type="button" class="btn btn-sm btn-primary" id="sidebarUpgrade" style="display:none;" onclick="startCheckout()" data-i18n="sub.activate">Aktivizo abonimin</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="logout()" data-i18n="nav.logout">Dil</button>
                </div>
            </div>
            <a href="/admin" class="link-admin" id="linkAdmin" style="display:none;">Paneli i administrimit</a>
        </aside>

        <!-- Main: chat + input -->
        <main class="main-area">
            <div id="trialBanner" class="trial-banner" style="display:none;"></div>
            <div id="paywallOverlay" class="paywall-overlay" style="display:none;">
                <div class="card">
                    <h2 id="paywallOverlayTitle">Prova falas ka përfunduar</h2>
                    <p id="paywallOverlayMessage">Aktivizo abonimin për të vazhduar me Albanian Law AI.</p>
                    <p class="price">4.99€ / muaj</p>
                    <div class="paywall-buttons">
                        <button class="btn btn-primary" id="paywallOverlaySubscribe" onclick="startCheckout()" style="min-width:200px;">Aktivizo Premium</button>
                        <a href="/pricing" class="btn btn-outline-light" style="text-decoration:none; margin-top:8px; font-size:.85rem;">Shiko planet</a>
                    </div>
                    <p class="paywall-note">1 ditë provë falas, pastaj 4.99€/muaj. Anulo kurdo.</p>
                </div>
            </div>

            <div class="chat-content">
                <!-- Document toolbar: filter dropdown + upload (upload only visible to admin) -->
                <div class="doc-toolbar" id="docToolbar" style="display:none;">
                    <select id="docFilter" onchange="onDocFilterChange()">
                        <option value="">Të gjitha dokumentet</option>
                    </select>
                    <span class="doc-status" id="docStatusIndicator"></span>
                    <button type="button" class="btn-upload-mini admin-only" id="btnUpload" style="display:none;" onclick="document.getElementById('fileUploadInput').click()">&#128206; Ngarko</button>
                    <a href="/documents" class="btn-upload-mini admin-only" id="linkLibrary" style="display:none;">&#128196; Libraria</a>
                    <button type="button" class="btn-debug-toggle admin-only" id="debugToggle" style="display:none;" onclick="toggleDebugMode()" title="Debug mode OFF">&#128736;</button>
                    <input type="file" id="fileUploadInput" class="hidden-file-input" accept=".pdf,.docx,.doc,.txt" onchange="handleFileUpload(this)">
                </div>

                <!-- Document management panel (admin only) -->
                <div class="doc-panel admin-only" id="docPanel" style="display:none;">
                    <div class="doc-panel-header">
                        <span>Menaxhimi i dokumenteve</span>
                        <button type="button" class="btn-close-panel" onclick="toggleDocPanel()">&times;</button>
                    </div>
                    <div class="doc-panel-body" id="docPanelBody">
                        <div class="empty-state" style="padding:1.5rem;">
                            <p style="font-size:.85rem;">Nuk ka dokumente ende.</p>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message message-assistant">
                        <div class="message-bubble welcome-bubble">
                            <p><strong data-i18n="chat.welcome_title">Mirë se vini në Albanian Law AI!</strong></p>
                            <p data-i18n="chat.welcome_body">Mund t'i përgjigjem pyetjeve bazuar në legjislacionin shqiptar. Më pyet çdo gjë për ligjet, rregulloret ose procedurat juridike.</p>
                            <p class="welcome-note" data-i18n="chat.welcome_note">Përgjigjem në bazë të ligjeve dhe rregulloreve në sistem. Çdo përgjigje shoqërohet me burime dhe referenca.</p>
                        </div>
                    </div>
                    <!-- Suggested questions moved to sidebar -->
                </div>
                <div class="chat-input-area">
                    <div id="suggestPanel" class="suggest-panel" style="display:none;"></div>
                    <div class="chat-input-wrapper">
                        <textarea id="chatInput" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this); onInputChange(this);" placeholder="Shkruaj pyetjen tënde për ligjet shqiptare…" title=""></textarea>
                        <button class="btn btn-primary btn-send" onclick="sendMessage()" id="sendBtn" title="Dërgo">&#10148;</button>
                    </div>
                    <p class="chat-disclaimer" data-i18n="chat.disclaimer">Përgjigjet bazohen në legjislacionin në sistem. Kontrollo gjithmonë me burime zyrtare.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth modal (guest tries to send without login) -->
    <div id="authModal" class="auth-modal-backdrop" style="display:none;">
        <div class="auth-card card">
            <div class="auth-tabs">
                <button type="button" class="auth-tab" data-tab="login" data-i18n="auth.sign_in">Hyr</button>
                <button type="button" class="auth-tab active" data-tab="register">Regjistrohu</button>
            </div>
            <p class="auth-subtitle" id="authModalSubtitle" style="margin-bottom:1rem;" data-i18n="auth.signup_to_start">Regjistrohu falas për 1 ditë provë dhe fillo të bisedosh.</p>
            <div id="authModalLogin" class="auth-form" style="display:none;">
                <form onsubmit="return handleModalLogin(event)">
                    <div class="form-group">
                        <label data-i18n="auth.email">Email</label>
                        <input type="email" id="modalLoginEmail" required placeholder="ju@shembull.com">
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.password">Fjalëkalimi</label>
                        <input type="password" id="modalLoginPassword" required placeholder="••••••••">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" data-i18n="auth.sign_in">Hyr</button>
                </form>
            </div>
            <div id="authModalRegister" class="auth-form">
                <form onsubmit="return handleModalRegister(event)">
                    <div class="form-group">
                        <label data-i18n="auth.email">Email</label>
                        <input type="email" id="modalRegisterEmail" required placeholder="ju@shembull.com">
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.password_hint">Fjalëkalimi (të paktën 8 karaktere)</label>
                        <input type="password" id="modalRegisterPassword" required minlength="8" placeholder="••••••••">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" data-i18n="auth.create_account_btn">Krijo llogari</button>
                </form>
            </div>
            <button type="button" class="btn btn-sm" style="margin-top:1rem; background:transparent; color:var(--text-muted);" onclick="closeAuthModal()">Mbyll</button>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/chat.js"></script>
    <script>
        function t(key, opts) { return typeof __t !== 'undefined' ? __t(key, opts) : key; }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function showPaywallOverlay() {
            var el = document.getElementById('paywallOverlay');
            if (el) { el.style.display = 'flex'; el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        }

        document.querySelectorAll('#authModal .auth-tab').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var tab = btn.getAttribute('data-tab');
                document.querySelectorAll('#authModal .auth-tab').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                document.getElementById('authModalLogin').style.display = tab === 'login' ? 'block' : 'none';
                document.getElementById('authModalRegister').style.display = tab === 'register' ? 'block' : 'none';
                document.getElementById('authModalSubtitle').textContent = tab === 'login' ? t('auth.login_to_start') : t('auth.signup_to_start');
            });
        });

        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target === this) closeAuthModal();
        });

        async function handleModalLogin(e) {
            e.preventDefault();
            var email = document.getElementById('modalLoginEmail').value.trim();
            var password = document.getElementById('modalLoginPassword').value;
            try {
                var res = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password }) });
                var data = await res.json();
                if (!res.ok) throw new Error(data.detail || t('error.login_failed'));
                if (typeof setToken === 'function') setToken(data.token);
                closeAuthModal();
                window.location.reload();
            } catch (err) {
                showToast(err.message, 'error');
            }
            return false;
        }

        async function handleModalRegister(e) {
            e.preventDefault();
            var email = document.getElementById('modalRegisterEmail').value.trim();
            var password = document.getElementById('modalRegisterPassword').value;
            try {
                var res = await fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, password: password }) });
                var data = await res.json();
                if (!res.ok) throw new Error(data.detail || t('error.register_failed'));
                if (typeof setToken === 'function') setToken(data.token);
                closeAuthModal();
                window.location.reload();
            } catch (err) {
                showToast(err.message, 'error');
            }
            return false;
        }

        (async function initApp() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('subscription') === 'success') {
                if (typeof showToast === 'function') showToast('Pagesa u krye me sukses! Mirë se vini në Premium.', 'success');
                window.history.replaceState({}, '', '/app');
            } else if (urlParams.get('subscription') === 'failed') {
                if (typeof showToast === 'function') showToast('Pagesa nuk u krye. Provoni përsëri.', 'error');
                window.history.replaceState({}, '', '/app');
            }

            var token = typeof getToken === 'function' ? getToken() : null;

            if (!token) {
                document.getElementById('sidebarLogin').style.display = 'block';
                document.getElementById('sidebarSignup').style.display = 'block';
                document.getElementById('sidebarUser').style.display = 'none';
                document.getElementById('trialBanner').style.display = 'none';
                document.getElementById('paywallOverlay').style.display = 'none';
                window._canSend = false;
                return;
            }

            try {
                var res = await fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.status === 401) {
                    if (typeof clearToken === 'function') clearToken();
                    window.location.reload();
                    return;
                }
                var data = await res.json();
                document.getElementById('sidebarLogin').style.display = 'none';
                document.getElementById('sidebarSignup').style.display = 'none';
                document.getElementById('sidebarUser').style.display = 'block';
                document.getElementById('sidebarUserEmail').textContent = data.user.email;

                // Store admin flag globally for chat.js to use
                window._isAdmin = !!data.user.is_admin;

                if (data.user.is_admin) {
                    document.getElementById('linkAdmin').style.display = 'block';
                    var btnUpload = document.getElementById('btnUpload');
                    if (btnUpload) btnUpload.style.display = '';
                    var linkLib = document.getElementById('linkLibrary');
                    if (linkLib) linkLib.style.display = 'inline-flex';
                    var dbgToggle = document.getElementById('debugToggle');
                    if (dbgToggle) dbgToggle.style.display = '';
                    var docPanel = document.getElementById('docPanel');
                    if (docPanel) docPanel.style.display = '';
                }

                var hasSubscription = data.subscription && data.subscription.status;
                var hasBilling = data.billing && data.billing.active;
                var inTrial = data.trial && data.trial.in_trial;
                var trialDays = data.trial && data.trial.trial_days_left;
                var trialHours = data.trial && data.trial.trial_hours_left;

                if (data.user.is_admin || hasSubscription || hasBilling) {
                    document.getElementById('sidebarUpgrade').style.display = 'none';
                    document.getElementById('trialBanner').style.display = 'none';
                    document.getElementById('paywallOverlay').style.display = 'none';
                    window._canSend = true;
                } else if (inTrial) {
                    document.getElementById('sidebarUpgrade').style.display = 'none';
                    document.getElementById('paywallOverlay').style.display = 'none';
                    window._canSend = true;
                    var banner = document.getElementById('trialBanner');
                    banner.style.display = 'block';
                    banner.className = 'trial-banner';
                    // Show "Prova falas aktive deri më [date/time]"
                    var trialEnd = data.trial && data.trial.trial_ends_at;
                    if (trialEnd) {
                        try {
                            var endDate = new Date(trialEnd + 'Z');
                            var day = endDate.getDate().toString().padStart(2, '0');
                            var month = (endDate.getMonth() + 1).toString().padStart(2, '0');
                            var year = endDate.getFullYear();
                            var hours = endDate.getHours().toString().padStart(2, '0');
                            var mins = endDate.getMinutes().toString().padStart(2, '0');
                            var formatted = day + '/' + month + '/' + year + ' ' + hours + ':' + mins;
                            banner.textContent = 'Prova falas aktive deri më ' + formatted;
                            if (trialHours !== null && trialHours < 6) {
                                banner.className = 'trial-banner trial-banner-warning';
                            }
                        } catch (e) {
                            banner.textContent = 'Prova falas aktive';
                        }
                    } else {
                        banner.textContent = 'Prova falas aktive (24 orë)';
                    }
                } else {
                    document.getElementById('sidebarUpgrade').style.display = 'inline-flex';
                    document.getElementById('trialBanner').style.display = 'none';
                    document.getElementById('paywallOverlay').style.display = 'flex';
                    window._canSend = false;
                    document.getElementById('paywallOverlayTitle').textContent = t('paywall.trial_ended_short') || 'Prova falas ka përfunduar';
                    document.getElementById('paywallOverlayMessage').textContent = t('paywall.activate_to_continue') || 'Aktivizo abonimin për të vazhduar me Albanian Law AI.';
                }
            } catch (e) {
                if (typeof clearToken === 'function') clearToken();
                window.location.reload();
            }
        })();

        function logout() {
            var token = typeof getToken === 'function' ? getToken() : null;
            if (token) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                }).catch(function(){});
            }
            if (typeof clearToken === 'function') clearToken();
            window.location.href = '/login';
        }

        async function startCheckout() {
            var btn = document.getElementById('paywallOverlaySubscribe');
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Duke u drejtuar te PayPal...';
            try {
                var token = typeof getToken === 'function' ? getToken() : null;
                var cfgRes = await fetch('/api/billing/config');
                var cfg = await cfgRes.json();
                if (!cfg.payments_configured) {
                    throw new Error('Pagesat do të aktivizohen së shpejti. Provoni përsëri më vonë.');
                }
                var res = await fetch('/api/billing/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                });
                var data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Gabim');
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (err) {
                if (typeof showToast === 'function') showToast(err.message, 'error');
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        window.showPaywallOverlay = function() {
            document.getElementById('paywallOverlay').style.display = 'flex';
        };

        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('subscription') === 'success') {
            window.history.replaceState({}, '', '/app');
            if (typeof showToast === 'function') {
                setTimeout(function() { showToast('Abonimi u aktivizua me sukses!', 'success'); }, 500);
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        // ── Suggested Questions (sidebar) ──────────────────
        async function loadSuggestedQuestions() {
            try {
                var res = await fetch('/api/suggested-questions');
                if (!res.ok) return;
                var data = await res.json();
                renderSidebarQuestions(data.categories || []);
            } catch (e) { /* silent */ }
        }

        function renderSidebarQuestions(categories) {
            var container = document.getElementById('sidebarSuggestedQuestions');
            if (!container) return;
            if (!categories.length) { container.innerHTML = ''; return; }

            var html = '<div class="sidebar-sq-title">Pyetje t\u00eb sugjeruara</div>';
            categories.forEach(function(cat, ci) {
                html += '<div class="sidebar-sq-cat" id="sqCat_' + ci + '">';
                html += '<div class="sidebar-sq-cat-header" onclick="toggleSQCat(' + ci + ')">';
                html += '<span>' + escHTML(cat.name) + '</span>';
                html += '<span class="sq-arrow">&#9654;</span>';
                html += '</div>';
                html += '<div class="sidebar-sq-cat-body">';
                cat.questions.forEach(function(q) {
                    html += '<button type="button" class="sidebar-sq-q" onclick="useSidebarQuestion(this)" data-question="' + escAttr(q.question) + '">' + escHTML(q.question) + '</button>';
                });
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        function toggleSQCat(ci) {
            var el = document.getElementById('sqCat_' + ci);
            if (el) el.classList.toggle('open');
        }

        function useSidebarQuestion(btn) {
            var question = btn.getAttribute('data-question');
            if (!question) return;
            var input = document.getElementById('chatInput');
            if (input) {
                input.value = question;
                if (typeof autoResize === 'function') autoResize(input);
            }
            closeSidebar();
            if (typeof sendMessage === 'function') sendMessage();
        }

        function hideSuggestedQuestions() { /* no-op: questions live in sidebar permanently */ }

        function escHTML(s) {
            if (!s) return '';
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        function escAttr(s) {
            return escHTML(s).replace(/"/g, '&quot;');
        }

        loadSuggestedQuestions();
    </script>
</body>
</html>
